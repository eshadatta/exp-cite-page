# Quickstart

This will show you how to create a simple web site using the Hugo static site generator and then use the `static-page-id-generator` to assign and manage DOIs in the new site. These instructions are for the command line on your computer.

Open two terminal windows side-by-side. In one terminal we'll create the site. In the other terminal we'll run the commands needed to init the site for DOI assignment.

### There are two dependencies prior to using these instructions. You will need
- Git
- The most recent version of Hugo

## Create a new site and generate some content

**In terminal one**

We'll do everything in the `/tmp` directory

- `cd /tmp`

Create a new hugo site

- `hugo new site my_science_blog`

CD to the new site, initialize it as a git repo, add a theme, and create a minimal hugo config file

- `cd my_science_blog/`
- `git init`
- `git submodule add https://github.com/theNewDynamic/gohugo-theme-ananke.git themes/ananke`
- `echo "theme = 'ananke'" >> hugo.toml`
- **If you are a Crossref member and will be using the Crossref system for depositing metadata and registering DOIs, this will store the xml files used to deposit metadata into the Crossref system, you will need the following steps:**
  - `mkdir submission_info`. This directory will store the xml files that can be deposited into the Crossref system. Crossref's processes will deposit the metadata, register a DOI, and make it available in its services.
  - Copy the sample submission info yaml file. This will be needed to generate the xml for submission. 
    - `curl https://gitlab.com/crossref/labs/static-page-id-generator/-/raw/main/submission_workflow/submission_info.yml?ref_type=heads > submission_info.yml`
    - Change the contents of the file to reflect your information. Here is an example:
    ```
    depositor: 
        - name: "Test"
        - email: "t@test.org"
    registrant: Test"
    submission_path: "submission_info"
    batch_id: "test.id.batch"
    ```

Generate a sample document

- `hugo new content posts/my-first-post.md`. If you open `posts/my-first-post.md`, the file will look like this:
```
+++
title = 'My First Post'
date = Date the post was created
draft = false
+++
```

Edit `my-first-post.md`, add the `x-version= "0.0.0"` and add some text to the post and set `draft` to `false`. The post will look like this:
```
+++
title = 'My First Post'
date = 2023-10-26T13:12:40-04:00
draft = false
x-version = "0.0.0"
+++
test test
```

Check to see everything is working

- `hugo serve`
- `^C` to quit.

Check everything into git.

- `git add .`
- `git commit -m “first commit”`

## Get static-page-id generator and start generating DOIs

**In terminal 2**

- `cd /tmp`
- `git clone git@gitlab.com:crossref/labs/static-page-id-generator.git`
- `cd static-page-id-generator`
- `python -m venv venv`
- `source ./venv/bin/activate`
- `pip install -r requirements.txt`

**For a full description of all the arguments for the static-page-id-generator script, please check [here](https://gitlab.com/crossref/labs/static-page-id-generator/-/blob/main/README.md?ref_type=heads#usage-examples).**

After all the requirements have been installed, we will first initialize the repository. The script will notify the user that it has created a config and pid tracking file. 
```
python run_all.py init -r /tmp/my_science_blog/ -d "https://some-production-domain.org" --doi-prefix "10.5555"
Config file created: /tmp/my_science_blog/config.yml
Pid tracking file: /tmp/my_science_blog/pid.json created

```
The **config.yml** file will look like this:
```yaml
content:
- .
doi_prefix: '10.5555'
domain: "https://some-production-domain.org
id_type: doi
pid_file: pid.json
```

The **pid.json** will be an empty json file: `{}`

After the necessary files have been created, we will run the pid generator script in DRY RUN mode as a Crossref member.  This will run the following:
- the script generates a unique id for each file that is tagged
- Create urls for the files that are tagged

In DRY RUN mode, the script will **NOT** do the following:
- deposit the files to Crossref 
- register the DOI, and 
- add the DOIs back to the markdown files that the script is tracking.

The command below shows what happens. There is a known problem that the some of the markdown generated by hugo errors out with the script. The markdown files that create the errors are not needed for the script to continue processing.
```
python run_all.py gen-pid -r /tmp/my_science_blog/ -st crossref --info /tmp/my_science_blog/submission_info.yml -dry
Running in DRY RUN mode
In DRY RUN mode, script will generate:
1. unique identifier for each file with a x-version tag in frontmatter
2. URL based on website logic. Currently hardcoded for the Crossref website
3. Create a xml deposit file (currently hardcoded for Crossref) and save it to the specified directory
4. Script will NOT deposit the file
4. Script will NOT register a DOI
4. Script will NOT add the DOI back to the file
Generating PID(s)
ERROR: Invalid inline table encountered (line 3 column 1 char 63)
WARNING: Not processing: /tmp/my_science_blog/archetypes/default.md. There was an error or there is no markdown present
ERROR: while parsing a block mapping
  in "<unicode string>", line 2, column 1
did not find expected key
  in "<unicode string>", line 2, column 43
WARNING: Not processing: /tmp/my_science_blog/themes/ananke/archetypes/default.md. There was an error or there is no markdown present
Files in ['.'] have been processed and written to /tmp/my_science_blog/quickstart/pid.json
Generating URLs
Generating XML document for submission
SUCCESS! /tmp/my_science_blog/submission_info/20231029101102_submission.xml is valid. Ready for deposit
DRY RUN ended. Please check /tmp/my_science_blog/pid.json for information on the versioned files and /tmp/my_science_blog/submission_info/20231029101102_submission.xml for the xml deposit file
```
## After the script runs in DRY RUN mode:
The following files will be available: `pid.json` and if the script has been run as a Crossref member, the xml deposit file will be generated.

**pid.json**
```json
[
	{
		"file_commit_id": "4228798a64cb87bd4e018341b52aa468c436e806",
		"file_hash": "e79eb5ff002355c8139a4afedfde1a7092425478",
		"utc_commit_date": "2023-10-26 17:16:45",
		"current_id": "3ss2mgtfd2",
		"version": "0.0.0",
		"url": "https://some-production-domain.org/posts/my-first-post",
		"file": "content/posts/my-first-post.md",
		"title": "My First Post",
		"doi": {
			"submitted": null,
			"registered": null,
			"value": null
		},
		"production_domain": "https://some-production-domain.org",
		"doi_prefix": "10.5555"
	}
]
```

If the script was run as a Crossref member, a xml deposit file will be generated. 
The xml deposit file will look like this:
```xml
<?xml version='1.0' encoding='UTF-8'?>
<doi_batch xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.crossref.org/schema/5.3.0 https://www.crossref.org/schemas/crossref5.3.0.xsd"
    xmlns="http://www.crossref.org/schema/5.3.0" version="5.3.0">
    <head>
        <doi_batch_id>test.id.batch</doi_batch_id>
        <timestamp>20231029101102</timestamp>
        <depositor>
            <depositor_name>Test</depositor_name>
            <email_address>t@test.org</email_address>
        </depositor>
        <registrant>Test"</registrant>
    </head>
    <body>
        <posted_content type="other">
            <titles>
                <title>My First Post</title>
            </titles>
            <posted_date>
                <month>10</month>
                <day>29</day>
                <year>2023</year>
            </posted_date>
            <doi_data>
                <doi>10.5555/3ss2mgtfd2</doi>
                <resource>https://some-production-domain.org/posts/my-first-post</resource>
            </doi_data>
        </posted_content>
    </body>
</doi_batch>
```

